<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="splitPageTitle">Công Cụ Cắt Ảnh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="css/split.css"> <!-- Link đến file CSS riêng của split -->
    <link rel="icon" href="favicon.png" type="image/png">
</head>

<body>
    <!-- Language Switcher -->
    <div class="lang-switcher-container">
        <div class="lang-switcher btn-group">
            <button class="btn btn-outline-secondary lang-btn" data-lang="vi">VI</button>
            <button class="btn btn-outline-secondary lang-btn" data-lang="en">EN</button>
        </div>
    </div>
    <!-- ===== NAVBAR START (Custom CSS) ===== -->
    <nav class="custom-navbar">
        <div class="nav-container">
            <a class="nav-brand" href="index.html">
                <img style="max-height: 40px; display: inline-block; vertical-align: middle;" src="logo.png" alt="Logo">
            </a>

            <button class="nav-toggler" id="navbarToggler" aria-label="Toggle navigation">
                <span class="nav-toggler-icon"></span>
            </button>

            <div class="nav-collapse" id="navbarNavContent">
                <ul class="nav-menu">
                    <li class="nav-menu-item ">
                        <a class="nav-menu-link" href="index.html" data-translate="navHome">Trang Chủ <span
                                class="screen-reader-only">(current)</span></a>
                    </li>
                    <li class="nav-menu-item ">
                        <a class="nav-menu-link" href="game.html" data-translate="navPlayGame">Chơi Game</a>
                    </li>
                    <li class="nav-menu-item">
                        <a class="nav-menu-link" href="about.html" data-translate="navAbout">Giới Thiệu</a>
                    </li>
                    <li class="nav-menu-item">
                        <a class="nav-menu-link" href="contact.html" data-translate="navContact">Liên Hệ</a>
                    </li>
                    <li class="nav-menu-item active">
                        <a class="nav-menu-link" href="split.html" data-translate="navImageTools">Cắt Ảnh</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- ===== NAVBAR END (Custom CSS) ===== -->
    <div style="padding-top: 80px;"></div>
    <div style="padding-top: 20px;" class="container">

        <!-- Tab lựa chọn công cụ (Tùy chọn, có thể bỏ nếu trang này chỉ làm resize) -->
        <ul class="nav nav-tabs mb-4" id="toolTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link " id="crop-square-tab" href="scale.html" role="tab" data-translate="toolSquareCropTitle">Cắt Ảnh Vuông</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" id="split-grid-tab" href="split.html" role="tab" data-translate="toolGridSplitTitle">Cắt Ảnh Lưới</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " id="resize-image-tab" href="resize.html" role="tab" data-translate="toolResizeTitle">Thay Đổi Kích Thước</a>
            </li>
        </ul>

        <h1 class="text-center mb-4" data-translate="splitPageTitle">Công Cụ Cắt Ảnh Thành Lưới</h1>
        <div class="alert alert-info" data-translate="splitAlert">
            Chọn ảnh từ máy tính, nhập số hàng và cột mong muốn, sau đó nhấn "Cắt Ảnh".
        </div>

        <!-- Khu vực Input -->
        <div class="row mb-4 align-items-end">
            <div class="col-md-5 form-group">
                <label for="image-input" data-translate="splitSelectFile">Chọn file ảnh:</label>
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="image-input"
                        accept="image/png, image/jpeg, image/gif, image/webp">
                    <label class="custom-file-label" for="image-input" data-browse="Duyệt" data-translate="resizeChooseFile">Chọn file...</label>
                </div>
            </div>
            <div class="col-md-2 form-group">
                <label for="rows-input" data-translate="splitRows">Số Hàng:</label>
                <input type="number" class="form-control" id="rows-input" value="3" min="1">
            </div>
            <div class="col-md-2 form-group">
                <label for="cols-input" data-translate="splitCols">Số Cột:</label>
                <input type="number" class="form-control" id="cols-input" value="3" min="1">
            </div>
            <div class="col-md-3 form-group">
                <button id="split-button" class="btn btn-warning btn-block" disabled data-translate="splitButton">Cắt Ảnh</button>
            </div>
        </div>

        <!-- Khu vực xem trước ảnh gốc -->
        <div id="preview-container">
            <span id="preview-placeholder" data-translate="splitNoImage">Chưa có ảnh nào được chọn</span>
            <img id="preview-image" src="#" alt="Ảnh xem trước">
        </div>

        <!-- Khu vực hiển thị thông báo lỗi -->
        <div id="error-message" class="text-center"></div>


        <!-- Khu vực hiển thị các mảnh đã cắt -->
        <div id="tiles-output">
            <!-- Các mảnh ảnh sẽ được thêm vào đây bằng JavaScript -->
        </div>

    </div>
    <div style="padding-bottom: 80px;"></div>
    <!-- ===== MAIN CONTENT END ===== -->

<!-- ===== FOOTER START ===== -->
    <footer class="site-footer bg-dark text-white py-4">
        <div class="container-fluid"> <!-- SỬ DỤNG CONTAINER-FLUID Ở ĐÂY -->
            <div class="footer-content-wrapper"> <!-- THÊM DIV WRAPPER NÀY -->
                <div class="row">
                    <div class="col-md-3 mb-3 mb-md-0">
                        <img src="logo.png" alt="Logo" class="mb-2" style="max-height: 50px;">
                        <p class="small text-white-50" data-translate="footerUnlimited">Giải trí và sáng tạo không giới hạn. .</p>
                    </div>
                    <div class="col-md-3 col-4 mb-3 mb-md-0">
                        <h5 class="fw-semibold" data-translate="footerExplore">Khám Phá</h5>
                        <ul class="list-unstyled">
                            <li><a href="index.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerHome">Trang
                                    Chủ</a>
                            </li>
                            <li><a href="game.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerJigsaw">Game Xếp
                                    Hình</a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-3 col-4 mb-3 mb-md-0">
                        <h5 class="fw-semibold" data-translate="footerTools">Công cụ</h5>
                        <ul class="list-unstyled">
                            <li><a href="split.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerGridSplit">Công Cụ Cắt
                                    Ảnh Lưới</a></li>
                            <li><a href="scale.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerSquareCrop">Công Cụ Cắt
                                    Ảnh Vuông</a></li>
                        </ul>
                    </div>
                    <div class="col-md-3 col-4">
                        <h5 class="fw-semibold" data-translate="footerInfo">Thông Tin</h5>
                        <ul class="list-unstyled">
                            <li><a href="about.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerAbout">Giới
                                    Thiệu</a>
                            </li>
                            <li><a href="contact.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerContact">Liên
                                    Hệ</a>
                            </li>
                            <li><a href="terms.html" class="text-white-50 text-decoration-none hover-light" data-translate="footerTerms">Điều
                                    Khoản</a></li>
                            <!-- Thêm link Điều khoản nếu có -->
                        </ul>
                    </div>
                </div>
                <hr class="my-3 border-secondary">
                <div class="row">
                    <div class="col-12 text-center">
                        <p class="small text-white-50 mb-0" data-translate="footerCopyright">
                            © <span id="currentYear"></span> Game & Ảnh Pro. Phát triển bởi Trần Hữu Đạt. Bảo lưu mọi
                            quyền.
                        </p>
                        <p class="small text-white-50" data-translate="footerBuiltWith">
                            <small>Xây dựng với <i class="fas fa-heart text-danger"></i> và Bootstrap, jQuery.</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- ===== FOOTER END ===== -->
    <!-- jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script src="js/translations.js"></script>
    <script src="js/setLanguage.js"></script>
    <script src="js/i18n.js"></script>

    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const imageInput = document.getElementById('image-input');
            const previewImage = document.getElementById('preview-image');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            const rowsInput = document.getElementById('rows-input');
            const colsInput = document.getElementById('cols-input');
            const splitButton = document.getElementById('split-button');
            const tilesOutput = document.getElementById('tiles-output');
            const errorMessage = document.getElementById('error-message');
            const fileLabel = document.querySelector('.custom-file-label');

            let originalImage = null;
            let originalFileName = 'image';

            imageInput.addEventListener('change', function (e) {
                errorMessage.textContent = '';
                tilesOutput.innerHTML = '';
                const file = e.target.files[0];
                if (!file) {
                    previewImage.style.display = 'none';
                    previewPlaceholder.style.display = 'inline';
                    splitButton.disabled = true;
                    fileLabel.textContent = 'Chọn file...';
                    originalImage = null;
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    showError('Vui lòng chọn một file ảnh hợp lệ (png, jpg, gif, webp).');
                    previewImage.style.display = 'none';
                    previewPlaceholder.style.display = 'inline';
                    splitButton.disabled = true;
                    fileLabel.textContent = 'Chọn file...';
                    imageInput.value = '';
                    originalImage = null;
                    return;
                }

                originalFileName = file.name.split('.').slice(0, -1).join('.') || 'image';

                const reader = new FileReader();
                reader.onload = function (event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    previewPlaceholder.style.display = 'none';

                    originalImage = new Image();
                    originalImage.onload = () => {
                        console.log(`Ảnh đã tải: ${originalImage.naturalWidth}x${originalImage.naturalHeight}`);
                        splitButton.disabled = false;
                    };
                    originalImage.onerror = () => {
                        showError('Không thể tải ảnh để xử lý.');
                        splitButton.disabled = true;
                        originalImage = null;
                    };
                    originalImage.src = event.target.result;
                }
                reader.readAsDataURL(file);
                fileLabel.textContent = file.name;
            });

            splitButton.addEventListener('click', function () {
                errorMessage.textContent = '';
                tilesOutput.innerHTML = '';

                if (!originalImage || !originalImage.complete || originalImage.naturalWidth === 0) {
                    showError('Ảnh chưa được tải hoặc không hợp lệ. Vui lòng chọn lại ảnh.');
                    return;
                }

                const rows = parseInt(rowsInput.value);
                const cols = parseInt(colsInput.value);

                if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) {
                    showError('Số hàng và số cột phải là số nguyên dương.');
                    return;
                }

                console.log(`Bắt đầu cắt thành ${rows} hàng, ${cols} cột.`);
                splitImageIntoTiles(originalImage, rows, cols);
            });

            function splitImageIntoTiles(img, rows, cols) {
                const naturalWidth = img.naturalWidth;
                const naturalHeight = img.naturalHeight;
                const tileWidth = Math.floor(naturalWidth / cols);
                const tileHeight = Math.floor(naturalHeight / rows);

                console.log(`Kích thước mảnh: ${tileWidth}x${tileHeight}`);

                if (tileWidth === 0 || tileHeight === 0) {
                    showError('Kích thước ảnh quá nhỏ hoặc số hàng/cột quá lớn.');
                    return;
                }

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const sx = c * tileWidth;
                        const sy = r * tileHeight;
                        const sWidth = (c === cols - 1) ? (naturalWidth - sx) : tileWidth;
                        const sHeight = (r === rows - 1) ? (naturalHeight - sy) : tileHeight;

                        const canvas = document.createElement('canvas');
                        canvas.width = sWidth;
                        canvas.height = sHeight;
                        const ctx = canvas.getContext('2d');

                        try {
                            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

                            const tileImg = document.createElement('img');
                            const dataUrl = canvas.toDataURL('image/png');
                            tileImg.src = dataUrl;
                            tileImg.alt = `Mảnh ${r + 1}-${c + 1}`;

                            const pieceNumber = (r * cols) + (c + 1);
                            const downloadLink = document.createElement('a');
                            const fileName = `anh_${pieceNumber}.png`;

                            downloadLink.href = dataUrl;
                            downloadLink.download = fileName;
                            downloadLink.textContent = `Tải ảnh-${pieceNumber}`;
                            downloadLink.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'mt-1');

                            const tileContainer = document.createElement('div');
                            tileContainer.classList.add('tile-container');
                            tileContainer.appendChild(tileImg);
                            tileContainer.appendChild(downloadLink);

                            tilesOutput.appendChild(tileContainer);

                        } catch (error) {
                            console.error(`Lỗi khi vẽ mảnh (${r}, ${c}):`, error);
                            showError(`Có lỗi xảy ra khi xử lý mảnh ảnh (${r + 1}, ${c + 1}).`);
                        }
                    }
                }
                console.log("Cắt ảnh hoàn tất.");
            }

            function showError(message) {
                errorMessage.textContent = message;
                console.error("Lỗi:", message);
            }

            document.querySelector('.custom-file-input').addEventListener('change', function () {
                let fileName = this.value.split('\\').pop();
                this.nextElementSibling.classList.add("selected");
                this.nextElementSibling.innerHTML = fileName || 'Chọn file...';
            });
        });
    </script>

</body>

</html>